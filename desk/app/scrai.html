<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Scrai</title>
  <style>
    /* ---------- layout & typography ---------- */
    * { box-sizing: border-box; }
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      color: #333;
    }
    .container {
      width: 100%;
      max-width: 800px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    /* ---------- conversation ---------- */
    #messagesContainer {
      flex: 1 1 auto;
      overflow-y: auto;
      padding-right: 4px; /* space for scrollbar */
      max-height: 70vh;
    }
    .message {
      padding: 8px 12px;
      border-radius: 6px;
      margin-bottom: 8px;
      line-height: 1.4;
      word-wrap: break-word;
      max-width: 75%;
    }
    .message.system    { background: #e9ecef; color: #555; align-self: center; max-width: 90%; }
    .message.user      { background: #007bff; color: #fff; align-self: flex-end; }
    .message.assistant { background: #fff; color: #333; border: 1px solid #ccc; align-self: flex-start; }
    .message.error     { background: #ffefef; color: #b00020; border: 1px solid #f5c2c7; align-self: stretch; max-width: 90%; }
    .message.scry      { background: #fff; border: 1px solid #ccc; padding: 0; }
    .message.scry > *  { margin: 0; }

    pre {
      background: #f0f0f0;
      padding: 12px;
      border-radius: 4px;
      overflow-x: auto;
      margin: 0;
    }

    /* ---------- input area ---------- */
    #requestInput {
      width: 100%;
      height: 80px;
      resize: vertical;
      font-size: 14px;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    /* ---------- buttons & spinner ---------- */
    #sendButton {
      padding: 10px 20px;
      font-size: 14px;
      background: #007bff;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s;
      align-self: flex-end;
    }
    #sendButton:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #ccc;
      border-top-color: #007bff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      vertical-align: middle;
      margin-left: 10px;
    }
    .hidden { display: none; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    /* ---------- run button ---------- */
    .run-btn {
      margin-top: 10px;
      padding: 6px 12px;
      font-size: 13px;
      border: none;
      border-radius: 4px;
      background: #28a745;
      color: #fff;
      cursor: pointer;
      transition: background 0.2s;
    }
    .run-btn:disabled { background: #6c757d; cursor: not-allowed; }
  </style>
</head>
<body>
  <div class="container">
    <div id="messagesContainer"></div>

    <textarea id="requestInput" placeholder="Type your message and hit Send…"></textarea>
    <div style="display: flex; align-items: center; gap: 8px;">
      <button id="sendButton">Send</button>
      <div id="loadingSpinner" class="spinner hidden"></div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      /* ---------- state ---------- */
      let lastMsgCount = 0;
      const seenPokes = new Set(); // prevent duplicate poke buttons

      /* ---------- element refs ---------- */
      const $ = id => document.getElementById(id);
      const messagesEl = $('messagesContainer');
      const inputEl    = $('requestInput');
      const sendBtn    = $('sendButton');
      const spinnerEl  = $('loadingSpinner');

      /* ---------- helpers ---------- */
      const safeJSONParse = txt => {
        try { return JSON.parse(txt); } catch (e) { console.error('JSON parse error', e, txt); return null; }
      };

      // Some backends occasionally emit invalid numeric literals (e.g., 1.750.202.139.507).
      // We attempt a minimal sanitisation by quoting any suspicious time values.
      const sanitiseStateText = txt => txt.replace(/"time":\s*([0-9]+(?:\.[0-9]+){2,})/g, '"time":"$1"');

      const fetchState = () =>
        fetch('/scrai/state')
          .then(r => r.text())
          .then(t => safeJSONParse(sanitiseStateText(t)) || { messages: [] });

      const cleanAndParseJSON = str => {
        try {
          return JSON.parse(str
            .replace(/\\0a/g, '\n')
            .replace(/[\u0000-\u001F]/g, '')
          );
        } catch { return null; }
      };

      const scrollToBottom = () => {
        messagesEl.scrollTop = messagesEl.scrollHeight;
      };

      /* ---------- render ---------- */
      const renderMessage = msg => {
        const { who, text } = msg;

        // Handle special Urbit responses encoded as user messages
        if (who === 'user' && text.startsWith('<URBIT RESPONSE - ERROR> ')) {
          const errText = text.replace('<URBIT RESPONSE - ERROR> ', '');
          const div = document.createElement('div');
          div.className = 'message error';
          div.textContent = errText;
          messagesEl.appendChild(div);
          return;
        }
        if (who === 'user' && text.startsWith('<URBIT RESPONSE - SCRY RESULT> ')) {
          const html = text.replace('<URBIT RESPONSE - SCRY RESULT> ', '');
          const div = document.createElement('div');
          div.className = 'message scry';
          div.innerHTML = html;
          messagesEl.appendChild(div);
          return;
        }

        if (who === 'assistant') {
          const obj = cleanAndParseJSON(text);

          // If assistant text is JSON and contains a scry, ignore entirely
          if (obj && obj.scry) return;

          if (obj && obj.poke) {
            // Avoid adding identical poke twice
            if (seenPokes.has(obj.poke)) return;
            seenPokes.add(obj.poke);

            const wrap = document.createElement('div');
            wrap.className = 'message assistant';

            const pre = document.createElement('pre');
            pre.textContent = obj.poke;
            wrap.appendChild(pre);

            const btn = document.createElement('button');
            btn.textContent = 'Run';
            btn.className = 'run-btn';
            btn.addEventListener('click', () => {
              btn.disabled = true;
              btn.textContent = 'Running…';
              fetch('/scrai', {
                method : 'POST',
                headers: { 'Content-Type': 'application/json' },
                body   : JSON.stringify({ run: { cord: obj.poke } })
              })
              .then(r => {
                if (!r.ok) throw new Error('Run failed');
                btn.textContent = 'Sent';
              })
              .catch(err => {
                console.error(err);
                btn.disabled = false;
                btn.textContent = 'Run';
                alert('Error running poke');
              });
            });
            wrap.appendChild(btn);
            messagesEl.appendChild(wrap);
            return;
          }

          let assistantText = text;
          if (obj && (obj.message || obj.text)) {
            assistantText = obj.message || obj.text;
          }

          const div = document.createElement('div');
          div.className = 'message assistant';
          div.textContent = assistantText;
          messagesEl.appendChild(div);
          return;
        }

        // System messages
        if (who === 'system') {
          const div = document.createElement('div');
          div.className = 'message system';
          div.textContent = text;
          messagesEl.appendChild(div);
          return;
        }

        // Regular user message
        const div = document.createElement('div');
        div.className = 'message user';
        div.textContent = text;
        messagesEl.appendChild(div);
      };

      const processState = state => {
        const msgs = state.messages || [];
        if (msgs.length > lastMsgCount) {
          const newMsgs = msgs.slice(lastMsgCount);
          newMsgs.forEach(renderMessage);
          lastMsgCount = msgs.length;
          scrollToBottom();
        }
      };

      /* ---------- polling loop ---------- */
      const poll = () => fetchState().then(processState).catch(err => console.error('Polling error', err));

      // Initial load then regular polling
      poll();
      setInterval(poll, 3000);

      /* ---------- send ---------- */
      sendBtn.addEventListener('click', () => {
        const text = inputEl.value.trim();
        if (!text) return;

        sendBtn.disabled = true;
        spinnerEl.classList.remove('hidden');

        fetch('/scrai', {
          method : 'POST',
          headers: { 'Content-Type': 'application/json' },
          body   : JSON.stringify({ send: { text } })
        })
        .then(r => {
          if (!r.ok) throw new Error('Send failed');
          inputEl.value = '';
          // message will be appended on next poll
        })
        .catch(err => {
          console.error(err);
          alert('Error sending message');
        })
        .finally(() => {
          sendBtn.disabled = false;
          spinnerEl.classList.add('hidden');
        });
      });
    });
  </script>
</body>
</html>